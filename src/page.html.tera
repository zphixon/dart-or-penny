<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8" />
    <link rel="icon" type="image/png" href="{{ page_root }}/.dop/pwa/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ page_root }}/.dop/pwa/favicon.svg" />
    <link rel="shortcut icon" href="{{ page_root }}/.dop/pwa/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ page_root }}/.dop/pwa/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="DartOrPenny" />
    <link rel="manifest" href="{{ page_root }}/.dop/pwa/site.webmanifest" crossorigin="use-credentials" />
    <title>{{ tab_title }}</title>
    <style>
      h1 { color: green; }
      .icon > img {
        max-height: 3em;
        max-width: 3em;
      }
      .filetable {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1px;
        background: green;
      }
      .row {
        display: grid;
        gap: 1px;
        grid-template-columns: 3em 3fr repeat(3, minmax(12em, 1fr));
      }
      .row > div {
        background: white;
        padding: 0.25em;
      }
      .row > .filename {
        word-break: break-all;
      }
      .icon {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      @media (max-width: 900px) {
        .accessed {
          display: none;
        }
        .row {
          grid-template-columns: 3em 3fr repeat(2, minmax(12em, 1fr));
        }
      }
      @media (max-width: 650px) {
        .created {
          display: none;
        }
        .row {
          grid-template-columns: 3em 3fr minmax(10em, 1fr);
        }
      }
      #searchboxdiv {
        display: flex;
        column-gap: 0.5em;
        padding-bottom: 1em;
      }
      @media (max-width: 530px) {
        #searchboxdiv {
          flex-direction: column;
          row-gap: 0.5em;
        }
      }
      #searchbox {
        flex-grow: 1;
      }
      .header {
        user-select: none;
      }
      .header.mostRecentFirst::after, .header.asc::after {
        content: "‚ñæ";
      }
      .header.mostRecentLast::after, .header.desc::after {
        content: "‚ñ¥";
      }
      #caseSensitiveDiv {
        white-space: nowrap;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, minimal-ui">
  </head>
  <body>
    <h1>
      {% for part in page_title_parts %}
        <a href="{{ part.href }}">{{ part.path }}</a>
        {% if not loop.last %}
          /
        {% endif %}
      {% endfor %}
    </h1>
    <div id="searchboxdiv">
      <button id="clearSearch">clear search</button>
      <input id="searchbox" type="text" placeholder="üîé search"/>
      <div id="caseSensitiveDiv">
        <label for="caseSensitive">case sensitive?</label>
        <input id="caseSensitive" type="checkbox"/>
      </div>
      <button id="searchEverywhere">search everywhere</button>
    </div>
    <div class="filetable">
      <div class="header row">
        <div class="header numfiles">{{ num_files }}</div>
        <div class="header filename">filename</div>
        <div class="header created">created</div>
        <div class="header modified">modified</div>
        <div class="header accessed">accessed</div>
      </div>
      {%- set_global last_dir = 0 -%}
      {% for dir in dirs %}
        {%- set_global last_dir = loop.index -%}
        <div class="dir row" data-key="{{ loop.index }}">
          <div class="dir icon">üìÅ</div>
          <div class="dir filename">
            <a href="{{ dir.filename }}">{{ dir.basename }}</a>
          </div>
          <div class="dir created">{{ dir.created }}</div>
          <div class="dir modified">{{ dir.modified }}</div>
          <div class="dir accessed">{{ dir.accessed }}</div>
        </div>
      {% endfor %}
      {% for file in files %}
        <div class="file row" data-key="{{ last_dir + loop.index }}">
          <div class="file icon">
            {% if file.thumbnail_filename %}
              <svg id="{{ file.thumbnail_filename }}" data-thumbnail="{{ file.thumbnail_filename }}" class="thumbnailSpinner" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner_P7sC{transform-origin:center;animation:spinner_svv2 .75s infinite linear}@keyframes spinner_svv2{100%{transform:rotate(360deg)}}</style><path d="M10.14,1.16a11,11,0,0,0-9,8.92A1.59,1.59,0,0,0,2.46,12,1.52,1.52,0,0,0,4.11,10.7a8,8,0,0,1,6.66-6.61A1.42,1.42,0,0,0,12,2.69h0A1.57,1.57,0,0,0,10.14,1.16Z" class="spinner_P7sC"/></svg>
            {% else %}
              üìÉ
            {% endif %}
          </div>
          <div class="file filename">
            <a href="{{ file.filename }}" target="_blank" rel="noopener noreferrer">{{ file.basename }}</a>
          </div>
          <div class="file created">{{ file.created }}</div>
          <div class="file modified">{{ file.modified }}</div>
          <div class="file accessed">{{ file.accessed }}</div>
        </div>
      {% endfor %}
    </div>
    <div hidden id="csrfToken">{{ csrf }}</div>
    <script type="text/javascript">
      let searchbox = document.getElementById("searchbox");
      let searchEverywhere = document.getElementById("searchEverywhere");
      let clearSearch = document.getElementById("clearSearch");
      let sensitive = document.getElementById("caseSensitive");

      function matches(haystack, needle) {
        if (needle == "") {
          return true;
        }
        let flags = "i";
        if (sensitive.checked) {
          flags = "";
        }
        return haystack.search(new RegExp(needle, flags)) >= 0;
        //return a.toLocaleLowerCase().indexOf(b.toLocaleLowerCase()) >= 0;
      }

      function filterList(filterQuery) {
        let rows = document.querySelectorAll(".row:not(.header)");
        for (let row of rows) {
          let filename = row.querySelector(".filename");
          if (filename == null) {
            continue;
          }
          if (matches(filename.innerText, filterQuery)) {
            // setting display to empty string resets to previous display property
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        }
      }

      function displayEverywhereSearchResults(filelist) {
        let fileTable = document.querySelector(".filetable");
        fileTable.style.display = 'none';

        for (result of document.querySelectorAll('.everywheresearch')) {
          result.remove();
        }
        for (file of filelist) {
          let div = document.createElement('div');
          div.classList.add('everywheresearch');

          let firsta = document.createElement("a");
          firsta.href = "{{ page_root }}";
          firsta.appendChild(document.createTextNode("{{ file_dir }}"));
          div.appendChild(firsta);

          let split = file.split('{{ path_sep }}');
          var total = "{{ page_root }}";
          let i = -1;
          for (part of split) {
            i += 1;
            if (part === "") {
              continue;
            }

            total += "/" + part;
            let a = document.createElement('a');
            a.href = total;
            if (i + 1 == split.length) {
              a.target = "_blank";
              a.rel = "noopener noreferrer";
            }
            a.appendChild(document.createTextNode(part));
            div.appendChild(document.createTextNode("/"));
            div.appendChild(a);
          }

          fileTable.parentElement.appendChild(div);
        }
      }

      let searchingEverywhere = false;
      function doSearchEverywhere() {
        searchingEverywhere = true;
        fetch(
          "{{ page_root }}/.dop/search?regex="
          + encodeURIComponent(searchbox.value)
          + (sensitive.checked ? "&case_insensitive=false" : "")
        )
          .then(response => response.json())
          .then(filelist => {
            displayEverywhereSearchResults(filelist);
          });
      }

      function doClearSearch() {
        searchingEverywhere = false;
        for (let everySearch of document.querySelectorAll(".everywheresearch")) {
          everySearch.remove();
        }

        let fileTable = document.querySelector(".filetable");
        fileTable.style.display = "";

        searchbox.value = "";
        filterList("");
      }

      searchbox.oninput = event => filterList(event.target.value);
      searchbox.onkeydown = event => {
        if (event.key === 'Enter' && searchingEverywhere) {
          doSearchEverywhere();
        }

        if (event.key === 'Escape') {
          doClearSearch();
        }
      };

      sensitive.onchange = _ => filterList(searchbox.value);

      clearSearch.onclick = _ => {
        doClearSearch();
      };

      searchEverywhere.onclick = _ => doSearchEverywhere();

      let headerFilename = document.querySelector(".header.filename");
      let headerCreated = document.querySelector(".header.created");
      let headerModified = document.querySelector(".header.modified");

      // first row is header
      let [_header, ...files] = document.querySelectorAll(".row");
      let dateSort = "default";
      function setDateSort() {
        if (dateSort == "default") {
          dateSort = "mostRecentFirst";
        } else if (dateSort == "mostRecentFirst") {
          dateSort = "mostRecentLast";
        } else if (dateSort == "mostRecentLast") {
          dateSort = "default";
        }
      }
      function doDateSort(by) {
        files.sort((a, b) => {
          if (dateSort == "mostRecentFirst") {
            return new Date(a.children[by].innerText) < new Date(b.children[by].innerText);
          } else if (dateSort == "mostRecentLast") {
            return new Date(a.children[by].innerText) > new Date(b.children[by].innerText);
          } else {
            return parseInt(a.dataset["key"]) > parseInt(b.dataset["key"]);
          }
        }).forEach(file => {
          file.parentElement.appendChild(file);
        });
      }
      headerCreated.onclick = _ => {
        let sorted = document.querySelector("." + dateSort);
        if (sorted) sorted.classList.remove(dateSort);
        if (sorted != headerCreated) dateSort = "default";
        setDateSort();
        headerCreated.classList.add(dateSort);
        doDateSort(2);
      };
      headerModified.onclick = _ => {
        let sorted = document.querySelector("." + dateSort);
        if (sorted) sorted.classList.remove(dateSort);
        if (sorted != headerModified) dateSort = "default";
        setDateSort();
        headerModified.classList.add(dateSort);
        doDateSort(3);
      };

      let nameSort = "default";
      function setNameSort() {
        if (nameSort == "default") {
          nameSort = "asc";
        } else if (nameSort == "asc") {
          nameSort = "desc";
        } else if (nameSort == "desc") {
          nameSort = "default";
        }
      }
      function doNameSort() {
        files.sort((a, b) => {
          if (nameSort == "asc") {
            return a.children[1].innerText.toUpperCase().localeCompare(b.children[1].innerText.toUpperCase());
          } else if (nameSort == "desc") {
            return -a.children[1].innerText.toUpperCase().localeCompare(b.children[1].innerText.toUpperCase());
          } else {
            return parseInt(a.dataset["key"]) > parseInt(b.dataset["key"]);
          }
        }).forEach(file => {
          file.parentElement.appendChild(file);
        });
      }
      headerFilename.onclick = _ => {
        let dateSorted = document.querySelector("." + dateSort);
        if (dateSorted) dateSorted.classList.remove(dateSort);
        if (dateSort != "default") {
          dateSort = "default";
          doDateSort(2); // this fucking sucks without react but i do NOT want to set it up
        }

        headerFilename.classList.remove(nameSort);
        setNameSort();
        headerFilename.classList.add(nameSort);
        doNameSort();
      }

      // i think i want react actually fuck
      let ttl = 604800016; // 1 week
      function getThumbnailExpiry(thumbname) {
        let storage = window.localStorage.getItem(thumbname);
        if (storage === null) return null;
        let object = JSON.parse(storage);
        if (new Date().getTime() > object.expiry + ttl) return null;
        return object.thumbnail;
      }
      function setThumbnailExpiry(thumbname, data) {
        let storage = JSON.stringify({thumbnail: data, expiry: new Date().getTime() + ttl});
        window.localStorage.setItem(thumbname, storage);
      }

      function setThumbnailElement(thumbname, data) {
        let parent = document.getElementById(thumbname).parentElement;
        while (parent.firstChild) {
          parent.removeChild(parent.lastChild);
        }
        let image = document.createElement("img");
        parent.appendChild(image);
        image.src = "data:image/webp;base64," + data;
      }

      let maySend = false;
      let csrf = document.getElementById("csrfToken").innerText;
      let socket = new WebSocket("{{ page_root }}/.dop/thumbnail?csrf=" + encodeURIComponent(csrf));
      socket.addEventListener("open", (_) => maySend = true);
      socket.addEventListener("message", (e) => {
        let response = JSON.parse(e.data);
        if (response.err) {
          console.error(response);
        } else {
          setThumbnailElement(response.thumbnail, response.data);
          setThumbnailExpiry(response.thumbnail, response.data);
        }
      });

      let queue = [];
      let callback = (entries, observer) => {
        entries.forEach((entry) => {
          let thumbname = entry.target.dataset["thumbnail"];
          if (entry.isIntersecting) {
            let data = getThumbnailExpiry(thumbname);
            if (data !== null) {
              setThumbnailElement(thumbname, data);
            } else if (maySend) {
              while (queue.length > 0) {
                socket.send(queue.pop());
              }
              socket.send(thumbname);
            } else {
              queue.push(thumbname);
            }
            observer.unobserve(entry.target);
          }
        });
      };
      let observer = new IntersectionObserver(callback, {
        rootMargin: "150px 0px 150px 0px"
      });
      document.querySelectorAll(".thumbnailSpinner").forEach((spinner) => {
        observer.observe(spinner);
      });
    </script>
  </body>
</html>